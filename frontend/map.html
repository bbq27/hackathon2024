<!DOCTYPE html>
<html>
<head>
    <title>Find That Pokemon</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #mapid {
            height: 100vh; /* 100% of the viewport height */
            width: 100vw; /* 100% of the viewport width */
        }
    </style>
</head>
<body>
    <div id="mapid"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Fetching Locations from API
        function fetchAndFormatNearestLocations(userId, range, count) {
            fetch(`https://mongo.lone-faerie.xyz/api/location/nearest?user_id=${userId}&range=${range}&count=${count}`)
                .then(response => response.json())
                .then(data => {
                    const formattedLocations = data.map(item => ({
                        lat: item.latitude,
                        lon: item.longitude,
                        userId: item.user_id
                    }));
                    return formattedLocations;
                })
                .catch(error => console.error('Failed to fetch locations:', error));
        }


        // Function for posting data to API
        async function postLocation(userId, latitude, longitude, timestamp) {
            try {
                var body = JSON.stringify({ 'latitude':latitude, 'longitude':longitude, 'timestamp':timestamp.toISOString() })
                const response = await fetch(`https://mongo.lone-faerie.xyz/api/location?user_id=${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body,
                    mode: "no-cors"
                });
                

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                console.log(data);
            } catch (error) {
                console.error('Error posting location:', error);
            }
        }


        // Initialize User ID (this will be taken from the login screen)
        var user_ID = "homosexual1";
        // Initialize map as global var
        var mymap;


        // TESTING FETCHING
        nearby_users = fetchAndFormatNearestLocations(user_ID, 10, 5)
        

        // Get location from user device
        var user_latitude;
        var user_longitude;
        function getLocation() {
            if ("geolocation" in navigator) {
                // Geolocation is supported, request the current position
                navigator.geolocation.getCurrentPosition(function(position) {
                    // Success callback
                    console.log("Latitude: " + position.coords.latitude);
                    console.log("Longitude: " + position.coords.longitude);

                    user_latitude = position.coords.latitude
                    user_longitude = position.coords.longitude

                    // Create map
                    mymap = L.map('mapid').setView([user_latitude, user_longitude], 13);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(mymap);
                    
                    L.marker([user_latitude, user_longitude])
                        .addTo(mymap)
                        .bindPopup("You")
                        .openPopup();

                    // Sending Location to API
                    postLocation(user_ID, user_latitude, user_longitude, new Date());


                    // TEST Creating Dummy Locations
                    // var dummyLocations = generateDummyLocations(position.coords.latitude, position.coords.longitude);
                    addMarkersToMap(nearby_users);



                }, function(error) {
                    // Error callback
                    console.error("Geolocation error: " + error.message);
                }, {
                    // Options (optional)
                    enableHighAccuracy: true, // Whether to request the device to use more precise methods to determine location
                    timeout: 5000, // Maximum time in milliseconds allowed for obtaining the position
                    maximumAge: 0 // Maximum age in milliseconds of a possible cached position that is acceptable to return
                });
            } else {
                // if geolocation isn’t supported
                console.log("Geolocation is not supported by this browser.");
            }
        }
        getLocation()

        // DEBUGGING
        console.log('######################WAAAAAAHAHAHAHHA')
        // not working fuck
        console.log(mymap)


        // Function for adding markers to map given list of locations
        function addMarkersToMap(locations) {
            locations.forEach(location => {
                L.marker([location.lat, location.lon]).addTo(mymap)
                    .bindPopup(`User ID: ${location.userId}`);
            });
        }

        // Test locations for the pokemon
        
        function generateDummyLocations(userLat, userLon) {
            var dummyLocations = [];
            for (let i = 0; i < 5; i++) {
                let randomLat = userLat + (Math.random() - 0.5) * 0.01; // Small variation
                let randomLon = userLon + (Math.random() - 0.5) * 0.01; // Small variation
                dummyLocations.push({ lat: randomLat, lon: randomLon, userId: 'user' + i });
            }

            return dummyLocations;
        }



        // Adding test users to database
        var random;
        for(let i=1; i<10; i++){
            random = Math.random()*1.5
            postLocation('Homosexual' + i, user_latitude + random, user_longitude + 2*random, new Date());
        }


        addMarkersToMap(dummyLocations)


    </script>
</body>
</html>
