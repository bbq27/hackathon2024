<!-- Using Real Data (CORS VERSION) -->
<!DOCTYPE html>
<html>
<head>
    <title>Find That Pokemon</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #mapid {
            height: 100vh; /* 100% of the viewport height */
            width: 100vw; /* 100% of the viewport width */
        }
    </style>
</head>
<body>
    <div id="mapid"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>

        // custom icons
        var user_icon = L.icon({
            iconUrl: 'user_icon_3.png',
            iconSize: [50, 50], // size of the icon
            iconAnchor: [25.5, 38], // point of the icon which will correspond to marker's location
            popupAnchor: [0, -45] // point from which the popup should open relative to the iconAnchor
        });
        var gay_icon = L.icon({
            iconUrl: 'gay_icon.png',
            iconSize: [45, 45], // size of the icon
            iconAnchor: [25.5, 38], // point of the icon which will correspond to marker's location
            popupAnchor: [0, -45] // point from which the popup should open relative to the iconAnchor
        });


        // Fetching Locations from API
        function fetchAndFormatNearestLocations(userId, range, count) {
            fetch(`https://mongo.lone-faerie.xyz/api/location/nearest?user_id=${userId}&range=${range}&count=${count}`
            ).then(response => response.json())
                .then(data => {
                    const formattedLocations = data.map(item => ({
                        lat: item.latitude,
                        lon: item.longitude,
                        userId: item.user_id
                    }));

                    // Add nearest users to map
                    addMarkersToMap(formattedLocations, mymap)

                    return formattedLocations;
                })
                .catch(error => console.error('Failed to fetch locations:', error));
        }

        // Function for posting data to API
        async function postLocation(userId, latitude, longitude, timestamp) {
            try {
                var body = JSON.stringify({ 'latitude':latitude, 'longitude':longitude, 'timestamp':timestamp.toISOString() })
                const response = await fetch(`https://mongo.lone-faerie.xyz/api/location?user_id=${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: body
                });
                console.log('Postlocation, body:' + body)

                fetchAndFormatNearestLocations(user_ID, 10, 5)

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            } catch (error) {
                console.error('Error posting location:', error);
            }
        }


        // Initialize User ID (this will be taken from the login screen)
        var user_ID = "homosexual1";
        var map;

        // Get location from user device
        var user_latitude;
        var user_longitude;
        function getLocation() {
            if ("geolocation" in navigator) {
                // Geolocation is supported, request the current position
                navigator.geolocation.getCurrentPosition(function(position) {
                    // Success callback
                    console.log("Latitude: " + position.coords.latitude);
                    console.log("Longitude: " + position.coords.longitude);

                    user_latitude = position.coords.latitude
                    user_longitude = position.coords.longitude

                    mymap = L.map('mapid').setView([user_latitude, user_longitude], 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    }).addTo(mymap);
                    
                    L.marker([user_latitude, user_longitude], {icon: user_icon}) // Add user marker
                        .addTo(mymap)
                        .bindPopup("You")
                        .openPopup();


                    // Posting Test Homosexuals
                    for(let i=1; i<10; i++){
                        postLocation('Homosexual' + i, 
                        user_latitude + Math.random()*.02-0.01, 
                        user_longitude + Math.random()*.02-0.01, 
                        new Date());
                    }


                    // Sending Location to API
                    postLocation(user_ID, user_latitude, user_longitude, new Date());

                }, function(error) {
                    // Error callback
                    console.error("Geolocation error: " + error.message);
                }, {
                    // Options (optional)
                    enableHighAccuracy: true, // Whether to request the device to use more precise methods to determine location
                    timeout: 5000, // Maximum time in milliseconds allowed for obtaining the position
                    maximumAge: 0 // Maximum age in milliseconds of a possible cached position that is acceptable to return
                });
            } else {
                // if geolocation isn’t supported
                console.log("Geolocation is not supported by this browser.");
            }
        }

        // Function for adding markers to map given list of locations
        function addMarkersToMap(locations, mymap) {
            locations.forEach(location => {
                L.marker([location.lat, location.lon], {icon:gay_icon}).addTo(mymap)
                    .bindPopup(location.userId);
            });
        }

        getLocation()
        // then post location
        // then fetch nearest users
        // then add markers

    </script>
</body>
</html>